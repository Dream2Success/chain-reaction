<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Chain Reaction â€” RGB</title>
<meta name="description" content="Chain Reaction â€” mobile friendly. Host on GitHub Pages." />
<style>
  :root{
    --bg1:#041020;
    --bg2:#071a2a;
    --muted:#9fb0cc;
    --red:#ff4d6d;
    --green:#4cc96b;
    --blue:#4cc9f0;
    --cell-gap:10px;
    --max-width:980px;
    --ui-radius:12px;
    --glass-w: clamp(58px, 14vw, 110px);
    --font: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:var(--font);-webkit-font-smoothing:antialiased;background:
    radial-gradient(900px 360px at 6% 8%, rgba(10,30,60,0.28), transparent 16%),
    linear-gradient(180deg,var(--bg1),var(--bg2)); color:#eaf3ff}
  /* center container */
  .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:12px}
  .card{width:100%;max-width:var(--max-width);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));border-radius:14px;padding:12px;box-shadow:0 18px 60px rgba(2,8,20,0.6);border:1px solid rgba(255,255,255,0.02)}
  /* minimal controls row */
  .topbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{background:linear-gradient(180deg,#1f6feb,#2c8cff);color:white;border:none;padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer;min-width:44px;display:inline-flex;align-items:center;justify-content:center}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06); color:#d7e8ff;padding:8px 10px}
  .select{background:transparent;border-radius:8px;padding:8px 10px;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
  .smallmuted{font-size:13px;color:var(--muted)}
  /* board */
  .board-wrap{display:flex;justify-content:center}
  .board{display:grid;grid-gap:var(--cell-gap);background:transparent;border-radius:10px;padding:6px;touch-action:manipulation;min-width:220px;max-width:100%}
  .cell{
    background: rgba(255,255,255,0.02);
    border-radius:10px;
    min-height: calc(var(--glass-w) * 1.05);
    display:flex;align-items:center;justify-content:center;position:relative;overflow:visible;box-shadow:0 8px 20px rgba(0,0,0,0.45);
    transition: transform 140ms ease, background 220ms;
    cursor:pointer;
    -webkit-tap-highlight-color: transparent;
  }
  .cell:active{ transform: translateY(2px) scale(0.995) }
  .orb-stack{ display:flex; flex-direction:column; gap:6px; align-items:center; justify-content:center; pointer-events:none; transform-origin:center}
  .orb{
    width:36px;height:36px;border-radius:50%;box-shadow:0 8px 18px rgba(0,0,0,0.42), inset 0 -6px 12px rgba(0,0,0,0.12);transition: transform 260ms cubic-bezier(.2,.9,.3,1), opacity 260ms; will-change: transform, opacity;
  }
  .orb.small{ width:24px;height:24px }
  .badge{ position:absolute; right:8px; top:8px; font-weight:800; font-size:12px; padding:4px 8px; border-radius:999px; background:rgba(0,0,0,0.35); color:#fff }
  .c-red{ background: linear-gradient(180deg,var(--red), #ff7a95); }
  .c-green{ background: linear-gradient(180deg,var(--green), #79e698); }
  .c-blue{ background: linear-gradient(180deg,var(--blue), #7edfff); }
  .pulse{ animation: pulse 420ms cubic-bezier(.2,.9,.3,1); }
  @keyframes pulse{ 0%{ transform: scale(0.86); opacity:0.9 } 60%{ transform: scale(1.16); opacity:1 } 100%{ transform: scale(1); opacity:1 } }
  .shake{ animation: shake 520ms cubic-bezier(.25,.8,.25,1); }
  @keyframes shake { 0%{ transform: translateX(0) } 20%{ transform: translateX(-8px) } 40%{ transform: translateX(6px) } 60%{ transform: translateX(-6px) } 80%{ transform: translateX(3px) } 100%{ transform: translateX(0) } }

  /* confetti */
  .confetti{ position:fixed;left:0;right:0;top:0;bottom:0;pointer-events:none;overflow:hidden;z-index:9999 }

  /* footer */
  footer{margin-top:10px;text-align:center;color:var(--muted);font-size:15px;padding:6px}

  /* responsive */
  @media (min-width:900px){
    .card{padding:16px}
  }
  @media (max-width:720px){
    .btn{padding:10px 10px;font-size:14px}
  }
</style>
</head>
<body>
<div class="wrap">
  <main class="card" role="application" aria-label="Chain Reaction game">
    <div class="topbar">
      <div class="controls" id="controlsLeft">
        <button id="newBtn" class="btn" title="New">New</button>
        <select id="sizeSelect" class="select" title="Grid size">
          <option value="4x6">4Ã—6</option>
          <option value="5x7" selected>5Ã—7</option>
          <option value="6x8">6Ã—8</option>
        </select>
        <input id="fillInput" type="range" min="30" max="100" value="78" style="width:110px" title="Fill density">
        <button id="soundToggle" class="btn ghost" title="Toggle sound">ðŸ”Š</button>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <div id="moves" class="smallmuted">0</div>
        <div id="chain" class="smallmuted">0</div>
      </div>
    </div>

    <div class="board-wrap">
      <div id="board" class="board" role="grid" aria-live="polite"></div>
    </div>

    <footer>Happy Dreams2Success</footer>
  </main>
</div>

<div class="confetti" id="confetti"></div>

<script>
/* Mobile-first Chain Reaction â€” simplified UI and polished animations
   - Single-file, host on GitHub Pages
   - Minimal visible text (only controls + stats + footer)
*/

(function(){
  // DOM nodes
  const board = document.getElementById('board');
  const newBtn = document.getElementById('newBtn');
  const sizeSelect = document.getElementById('sizeSelect');
  const fillInput = document.getElementById('fillInput');
  const soundToggle = document.getElementById('soundToggle');
  const movesEl = document.getElementById('moves');
  const chainEl = document.getElementById('chain');
  const confettiRoot = document.getElementById('confetti');

  // state
  let rows = 5, cols = 7;
  let fill = Number(fillInput.value);
  let grid = [];
  let cells = [];
  let moves = 0;
  let currentChain = 0;
  let best = Number(localStorage.getItem('cr_best') || 0);
  let audioCtx = (typeof AudioContext !== 'undefined') ? new AudioContext() : null;

  // colors & css class map
  const COLORS = ['red','green','blue'];
  const CSS = { red: 'c-red', green: 'c-green', blue: 'c-blue' };

  // adjust board CSS grid when size changes
  function setBoardGrid(){
    board.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
    board.style.gap = 'var(--cell-gap)';
  }

  function rebuild(){
    rows = Number(sizeSelect.value.split('x')[0]);
    cols = Number(sizeSelect.value.split('x')[1]);
    fill = Number(fillInput.value);
    grid = [];
    cells = [];
    moves = 0;
    currentChain = 0;
    updateStats();
    board.innerHTML = '';
    setBoardGrid();

    for(let r=0;r<rows;r++){
      const row = [];
      for(let c=0;c<cols;c++){
        // random initial
        const empty = Math.random()*100 > fill;
        const color = empty ? null : COLORS[Math.floor(Math.random()*COLORS.length)];
        const count = empty ? 0 : (1 + Math.floor(Math.random()*2));
        row.push({ r, c, color, count });

        const el = document.createElement('button');
        el.className = 'cell';
        el.dataset.r = r; el.dataset.c = c;
        el.setAttribute('aria-label', `Cell ${r+1}, ${c+1}`);
        el.addEventListener('click', onCellClick, {passive:true});
        el.addEventListener('touchstart', (e)=>{ e.preventDefault(); onCellClick({currentTarget: el}); }, {passive:false});
        board.appendChild(el);
        cells.push(el);
      }
      grid.push(row);
    }
    renderAll();
  }

  function neighbors(r,c){
    const out = [];
    if(r>0) out.push([r-1,c]);
    if(r<rows-1) out.push([r+1,c]);
    if(c>0) out.push([r,c-1]);
    if(c<cols-1) out.push([r,c+1]);
    return out;
  }
  function capacity(r,c){ return neighbors(r,c).length; }

  function renderCell(cell, el){
    el.innerHTML = '';
    if(cell.count > 0){
      const badge = document.createElement('div');
      badge.className = 'badge';
      badge.textContent = cell.count;
      el.appendChild(badge);
      const stack = document.createElement('div');
      stack.className = 'orb-stack';
      const show = Math.min(cell.count, 3);
      for(let i=0;i<show;i++){
        const orb = document.createElement('div');
        orb.className = 'orb ' + (CSS[cell.color] || CSS.red);
        orb.style.transform = `translateY(-${i*6}px)`;
        stack.appendChild(orb);
      }
      if(cell.count > 3){
        const small = document.createElement('div');
        small.className = 'orb small';
        small.style.position = 'relative';
        small.style.background = 'linear-gradient(180deg, rgba(255,255,255,0.04), rgba(0,0,0,0.04))';
        const plus = document.createElement('div');
        plus.textContent = '+' + (cell.count-3);
        plus.style.position='absolute'; plus.style.left='50%'; plus.style.top='50%'; plus.style.transform='translate(-50%,-50%)';
        plus.style.fontSize='11px'; plus.style.color='#fff'; plus.style.fontWeight='800';
        small.appendChild(plus);
        stack.appendChild(small);
      }
      el.appendChild(stack);
      el.style.background = 'linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03))';
    } else {
      el.style.background = 'rgba(255,255,255,0.015)';
    }
  }

  function renderAll(){
    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        const cell = grid[r][c];
        const el = cells[r*cols + c];
        renderCell(cell, el);
      }
    }
  }

  function beep(freq=220, time=0.06, vol=0.08){
    if(!audioCtx || !soundToggle.dataset.on) return;
    try{
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.frequency.value = freq; o.type='sine';
      g.gain.value = vol;
      o.connect(g); g.connect(audioCtx.destination);
      o.start();
      o.stop(audioCtx.currentTime + time);
      g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + time);
    }catch(e){}
  }

  function processChain(sr, sc){
    currentChain = 0;
    const q = [];
    let start = grid[sr][sc];
    if(start.count === 0){
      start.color = COLORS[Math.floor(Math.random()*COLORS.length)];
    }
    start.count += 1;
    moves++;
    updateStats();
    renderCell(start, cells[sr*cols + sc]);
    if(start.count > capacity(sr, sc)) q.push([sr, sc, start.color]);

    while(q.length){
      const [r,c,color] = q.shift();
      const cell = grid[r][c];
      currentChain++;
      pulseCell(r,c);
      const cap = capacity(r,c);
      cell.count -= cap;
      if(cell.count <= 0){ cell.count = 0; cell.color = null; }
      const nbs = neighbors(r,c);
      for(const [nr,nc] of nbs){
        const nb = grid[nr][nc];
        nb.count += 1;
        nb.color = color;
        beep(220 + Math.random()*160, 0.03, 0.04);
        renderCell(nb, cells[nr*cols + nc]);
        if(nb.count > capacity(nr,nc)){
          q.push([nr,nc, nb.color]);
        }
      }
      renderCell(cell, cells[r*cols + c]);
    }

    chainEl.textContent = currentChain;
    if(currentChain > best){ best = currentChain; localStorage.setItem('cr_best', best); }
    if(isCleared()){
      bigConfetti();
      beep(520, 0.18, 0.15);
    }
    updateStats();
  }

  function isCleared(){ for(let r=0;r<rows;r++) for(let c=0;c<cols;c++) if(grid[r][c].count>0) return false; return true; }

  function pulseCell(r,c){
    const el = cells[r*cols + c];
    el.classList.add('pulse');
    setTimeout(()=> el.classList.remove('pulse'), 420);
  }

  function smallConfettiAt(el){
    const rect = el.getBoundingClientRect();
    const root = confettiRoot.getBoundingClientRect();
    const cx = (rect.left + rect.right)/2 - root.left;
    const sy = rect.top - root.top;
    const colors = ['#ff4d6d','#4cc96b','#4cc9f0','#ffd166','#c77dff'];
    for(let i=0;i<12;i++){
      const e = document.createElement('div');
      e.style.position='absolute'; e.style.width = (6 + Math.random()*8)+'px'; e.style.height = (10 + Math.random()*18)+'px';
      e.style.left = (cx + (Math.random()*80 - 40)) + 'px';
      e.style.top = (sy + (Math.random()*20 - 8)) + 'px';
      e.style.background = colors[Math.floor(Math.random()*colors.length)];
      confettiRoot.appendChild(e);
      const destX = (Math.random()*300 - 150);
      const destY = root.height + 80 + Math.random()*150;
      const rot = Math.random()*720 - 360;
      e.animate([{ transform:'translateY(0) rotate(0deg)', opacity:1 }, { transform:`translate(${destX}px, ${destY}px) rotate(${rot}deg)`, opacity:0.02 }], { duration: 900 + Math.random()*700, easing:'cubic-bezier(.2,.8,.2,1)' });
      setTimeout(()=> e.remove(), 2000 + Math.random()*800);
    }
  }

  function bigConfetti(){
    const root = confettiRoot.getBoundingClientRect();
    const colors = ['#ff4d6d','#4cc96b','#4cc9f0','#ffd166','#c77dff'];
    for(let i=0;i<40;i++){
      const e = document.createElement('div');
      e.style.position='absolute'; e.style.width = (6 + Math.random()*12)+'px'; e.style.height=(10 + Math.random()*18)+'px';
      e.style.left = (Math.random()*root.width) + 'px';
      e.style.top = (Math.random()*root.height*0.35) + 'px';
      e.style.background = colors[Math.floor(Math.random()*colors.length)];
      confettiRoot.appendChild(e);
      const destX = (Math.random()*800 - 400);
      const destY = root.height + 100 + Math.random()*240;
      const rot = Math.random()*720 - 360;
      e.animate([{ transform:'translateY(0) rotate(0deg)', opacity:1 }, { transform:`translate(${destX}px, ${destY}px) rotate(${rot}deg)`, opacity:0.04 }], { duration: 1200 + Math.random()*1000, easing:'cubic-bezier(.2,.8,.2,1)' });
      setTimeout(()=> e.remove(), 2200 + Math.random()*1200);
    }
  }

  function updateStats(){
    movesEl.textContent = moves;
    chainEl.textContent = currentChain;
  }

  function onCellClick(e){
    const el = e.currentTarget;
    const r = Number(el.dataset.r), c = Number(el.dataset.c);
    if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
    processChain(r,c);
    smallConfettiAt(el);
  }

  // wire controls
  newBtn.addEventListener('click', ()=> { if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume(); rebuild(); });
  sizeSelect.addEventListener('change', ()=> { rows = Number(sizeSelect.value.split('x')[0]); cols = Number(sizeSelect.value.split('x')[1]); rebuild(); });
  fillInput.addEventListener('input', ()=> { fill = Number(fillInput.value); });
  soundToggle.addEventListener('click', ()=> {
    if(!audioCtx) return;
    if(soundToggle.dataset.on){ soundToggle.dataset.on = ''; soundToggle.classList.remove('btn'); soundToggle.classList.add('btn','ghost'); soundToggle.textContent = 'ðŸ”‡'; }
    else { soundToggle.dataset.on = '1'; soundToggle.classList.remove('btn','ghost'); soundToggle.classList.add('btn'); soundToggle.textContent = 'ðŸ”Š'; }
  });

  // initialize audio toggle state
  soundToggle.dataset.on = '1';
  soundToggle.textContent = 'ðŸ”Š';

  // initial build
  function init(){
    setBoardGrid();
    rebuild();
  }

  // Ensure CSS grid columns updated
  function setBoardGrid(){ board.style.gridTemplateColumns = `repeat(${cols}, 1fr)`; board.style.gap = 'var(--cell-gap)'; }

  // start
  init();

  // expose for debugging
  window._ChainReaction = { rebuild };

  // resume audio on first gesture for some devices
  window.addEventListener('touchstart', ()=> { if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume(); }, {passive:true});
  window.addEventListener('click', ()=> { if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume(); }, {passive:true});
})();
</script>
</body>
</html>
